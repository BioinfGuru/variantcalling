########################
# Analysis on the Grid # 
########################

# create log folder
	
	mkdir -m 777 logs

# create bam

	qsub -cwd -j y -b yes -P NGS -N WTCHG_461109_50_FastqToSam -o /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/logs -q small.q /usr/java/latest8/bin/java -jar /NGS/Software/gatk-4.0.3.0/gatk-package-4.0.3.0-local.jar FastqToSam --FASTQ /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/WTCHG_461109_50_1.fastq.gz --FASTQ2 /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/WTCHG_461109_50_2.fastq.gz --OUTPUT /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/unmapped_WTCHG_461109_50_TEMP.bam --READ_GROUP_NAME WTCHG_461109_50 --PLATFORM_UNIT HNGMNBBXX.GTCTGTCA.5 --SAMPLE_NAME mpc372-2.5e --LIBRARY_NAME 106/18_MPX_10nM --PLATFORM illumina --SEQUENCING_CENTER WTCHG --RUN_DATE 2018-02-08

# mark adapters

	qsub -cwd -j y -b yes -P NGS -N WTCHG_461109_50_MarkAdapters -o /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/logs/ -q small.q /usr/java/latest8/bin/java -jar /NGS/Software/gatk-4.0.3.0/gatk-package-4.0.3.0-local.jar MarkIlluminaAdapters --INPUT /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/unmapped_WTCHG_461109_50_TEMP.bam --OUTPUT /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/markedadapters_WTCHG_461109_50_TEMP.bam --METRICS /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/WTCHG_461109_50_markadapters.metrics --TMP_DIR /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp


# make interleaved fastq

	qsub -cwd -j y -b yes -P NGS -N WTCHG_461109_50_InterLeaveFq -o /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/logs -q small.q /usr/java/latest8/bin/java -jar /NGS/Software/gatk-4.0.3.0/gatk-package-4.0.3.0-local.jar SamToFastq --INPUT /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/markedadapters_WTCHG_461109_50_TEMP.bam --FASTQ /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/WTCHG_461109_50_interleaved.fq --CLIPPING_ATTRIBUTE XT --CLIPPING_ACTION 2 --INTERLEAVE true --INCLUDE_NON_PF_READS true --TMP_DIR /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp

# map to ref

	printf 'bash -c "/NGS/Software/bwa/bwa mem -M -t 32 -p /NGS/musRefs_10/bwa_refs/ensembl92_mm10/Mus_musculus.GRCm38.dna.toplevel.fa /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/WTCHG_461109_50_interleaved.fq | /usr/java/latest8/bin/java -jar /NGS/Software/gatk-4.0.3.0/gatk-package-4.0.3.0-local.jar MergeBamAlignment --REFERENCE_SEQUENCE /NGS/musRefs_10/bwa_refs/ensembl92_mm10/Mus_musculus.GRCm38.dna.toplevel.fa --UNMAPPED_BAM /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/unmapped_WTCHG_461109_50_TEMP.bam --ALIGNED_BAM /dev/stdin --OUTPUT /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/mapped_WTCHG_461109_50_TEMP.bam --CREATE_INDEX true --ADD_MATE_CIGAR true --CLIP_ADAPTERS false --CLIP_OVERLAPPING_READS true --INCLUDE_SECONDARY_ALIGNMENTS true --MAX_INSERTIONS_OR_DELETIONS -1 --PRIMARY_ALIGNMENT_STRATEGY MostDistant --ATTRIBUTES_TO_RETAIN XS --TMP_DIR /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp"' > /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/command.sh

	qsub -cwd -j y -b yes -P NGS -N WTCHG_461109_50_Mapping -o /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/logs -pe big 32 sh /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/command.sh

# mark dups

	qsub -cwd -j y -b yes -P NGS -N WTCHG_461109_50_MarkDups -o /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/logs -q small.q /usr/java/latest8/bin/java -jar /NGS/Software/gatk-4.0.3.0/gatk-package-4.0.3.0-local.jar MarkDuplicates --INPUT /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/mapped_WTCHG_461109_50_TEMP.bam --OUTPUT /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/dedup_WTCHG_461109_50_TEMP.bam --METRICS_FILE /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/WTCHG_461109_50_dedup.metrics


# calc bqsr
	
	- WGS:
	
		qsub -cwd -j y -b yes -P NGS -N WTCHG_461109_50_CalcBQSR -o /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/logs -q small.q /usr/java/latest8/bin/java -jar /NGS/Software/gatk-4.0.3.0/gatk-package-4.0.3.0-local.jar BaseRecalibrator --input /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/dedup_WTCHG_461109_50_TEMP.bam --reference /NGS/musRefs_10/bwa_refs/ensembl92_mm10/Mus_musculus.GRCm38.dna.toplevel.fa --known-sites /NGS/musRefs_10/vcf/ensembl92_mm10/mus_musculus.vcf.gz --output /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/WTCHG_461109_50_before_bqsr.table 

	- WES

		qsub -cwd -j y -b yes -P NGS -N WTCHG_461109_50_index -o /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/logs -q small.q samtools index /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/dedup_WTCHG_461109_50_TEMP.bam

		qsub -cwd -j y -b yes -P NGS -N WTCHG_461109_50_CalcBQSR -o /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/logs -q small.q /usr/java/latest8/bin/java -jar /NGS/Software/gatk-4.0.3.0/gatk-package-4.0.3.0-local.jar BaseRecalibrator --input dedup_WTCHG_461109_50_TEMP.bam --reference /NGS/musRefs_10/bwa_refs/ensembl92_mm10/Mus_musculus.GRCm38.dna.toplevel.fa --known-sites /NGS/musRefs_10/vcf/ensembl92_mm10/mus_musculus.vcf.gz --output WTCHG_461109_50_before_bqsr.table -L /NGS/musRefs_10/bwa_refs/ensembl92_mm10/gene.intervals.bed -ip 100

# apply bqsr
	
	qsub -cwd -j y -b yes -P NGS -N WTCHG_461109_50_ApplyBQSR -o /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/logs -q small.q /usr/java/latest8/bin/java -jar /NGS/Software/gatk-4.0.3.0/gatk-package-4.0.3.0-local.jar ApplyBQSR --bqsr-recal-file /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/WTCHG_461109_50_before_bqsr.table --input /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/dedup_WTCHG_461109_50_TEMP.bam --output /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/WTCHG_461109_50.bam

	samtools flagstat /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/WTCHG_461109_50.bam > /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/WTCHG_461109_50_flagstat.metrics


# call variants 
	
	- WGS:

		chrlist=(1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 X Y) # mouse = 19, macaque = 20, human = 22

		for i in ${chrlist[*]}; do qsub -cwd -j y -b yes -P NGS -N CallVar_$i -o /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/logs -pe big 8 /usr/java/latest8/bin/java -jar /NGS/Software/gatk-4.0.3.0/gatk-package-4.0.3.0-local.jar HaplotypeCaller --input /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/WTCHG_461109_50.bam --output /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/$i.gz --reference /NGS/musRefs_10/bwa_refs/ensembl92_mm10/Mus_musculus.GRCm38.dna.toplevel.fa --emit-ref-confidence GVCF --dbsnp /NGS/musRefs_10/vcf/ensembl92_mm10/mus_musculus.vcf.gz --native-pair-hmm-threads 8 -L $i; done;

		bcftools concat -o /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/WTCHG_461109_50.gvcf /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/1.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/2.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/3.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/4.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/5.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/6.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/7.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/8.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/9.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/10.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/11.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/12.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/13.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/14.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/15.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/16.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/17.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/18.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/19.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/X.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/Y.gz

		bgzip WTCHG_461109_50.gvcf

		tabix -p vcf WTCHG_461109_50.gvcf.gz
		
	- WES:

		chrlist=(1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 X Y) # mouse = 19, macaque = 20, human = 22

		for i in ${chrlist[*]}; do qsub -cwd -j y -b yes -P NGS -N WTCHG_461109_50_split_$i -o /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/logs -q small.q samtools view -b /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/WTCHG_461109_50.bam $i -o /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/$i.bam; done;

		for i in ${chrlist[*]}; do qsub -cwd -j y -b yes -P NGS -N WTCHG_461109_50_index_$i -o /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/logs -q small.q samtools index /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/$i.bam; done;

		for i in ${chrlist[*]}; do qsub -cwd -j y -b yes -P NGS -N WTCHG_461109_50_CallVar_$i -o /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/logs -pe big 8 /usr/java/latest8/bin/java -jar /NGS/Software/gatk-4.0.3.0/gatk-package-4.0.3.0-local.jar HaplotypeCaller --input /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/$i.bam --output /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/$i.gz --reference /NGS/musRefs_10/bwa_refs/ensembl92_mm10/Mus_musculus.GRCm38.dna.toplevel.fa --emit-ref-confidence GVCF --dbsnp /NGS/musRefs_10/vcf/ensembl92_mm10/mus_musculus.vcf.gz --native-pair-hmm-threads 8 -L /NGS/musRefs_10/bwa_refs/ensembl92_mm10/gene.intervals.$i.bed -ip 100; done;

		bcftools concat -o /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/WTCHG_461109_50.gvcf /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/1.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/2.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/3.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/4.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/5.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/6.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/7.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/8.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/9.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/10.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/11.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/12.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/13.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/14.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/15.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/16.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/17.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/18.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/19.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/X.gz /NGS/users/Kenneth/jobs/michelle_simon/mm10_analysis/temp/Y.gz

		bgzip WTCHG_461109_50.gvcf

		tabix -p vcf WTCHG_461109_50.gvcf.gz

# tidy
	
	rm -rf temp *TEMP.ba* *fq *table
